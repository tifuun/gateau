<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gateau User Manual: Info for maintainers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Gateau User Manual
   </div>
   <div id="projectbrief">Atmospheric simulation of astronomical signals</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('maintainers.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Info for maintainers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This file contains all the hairy details that ideally should be of no concern for users and casual contributors, but are important for maybetree, Arend, and whatever poor souls who will have to carry the burden of maintaining Gateau in the future.</p>
<h2><a class="anchor" id="autotoc_md0"></a>
Manual Compiling</h2>
<p>The general procedure for compiling Gateau from this repo is like so:</p>
<ol type="1">
<li>Install Python, gcc, cmake, <code>gsl-devel</code> using your system package manager.<ul>
<li><code>gsl-devel</code> is usually called <code>libgsl-dev</code> on Debian-like distros.</li>
</ul>
</li>
</ol>
<ol type="1">
<li>(optional) create and activate venv</li>
</ol>
<ol type="1">
<li><code>pip install -e .</code></li>
</ol>
<p>Pip should automatically compile <code>libgateau.so</code> (which is placed under <code>src/gateau/libgateau.so</code> when installing in pip's Editable mode) using cmake. After compilation is done, you can verify that things work using <code>unittest</code>. Note that some tests will always fail if you don't have a GPU that gateau can use:</p>
<ol type="1">
<li><code>python -m unittest</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md1"></a>
For developers: using the &lt;tt&gt;test-all.sh&lt;/tt&gt; script</h2>
<p>Building, testing, and packaging Gateau requires a very hairy toolchain and some rather counterintuitive command line incantations. To make our lives easier, we have written a script which automates all of this using Podman. Here's how to use it:</p>
<ol type="1">
<li>Install and set up <code>podman</code> using your system's package manager</li>
</ol>
<ol type="1">
<li>Set up <code>podman</code> for use with CUDA. Read <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/cdi-support.html">NVIDIA's docs</a> or the <a href="https://github.com/stratal-systems/wiki/blob/main/wiki/void-linux-cuda.md">STRATAL SYSTEMS Wiki page</a> for instructions on how to do this.<ul>
<li>If you do not have a GPU, you can skip this step and instead run the script with <code>GATEAU_DISABLE_GPU=1</code>. Things that require a GPU will of course fail, but things like compiling and packaging will still work.</li>
</ul>
</li>
</ol>
<ol type="1">
<li>Run <code>./podman/test-all.sh pull</code> to download all of the containers needed for testing, building, and packaging Gateau.<ul>
<li>Alternatively, you can use <code>./podman/test-all.sh build</code> to build the containers locally</li>
</ul>
</li>
</ol>
<p>What follows below is a brief cookbook of things you can do with the <code>test-all.sh</code> script. If you want a complete documentation of what it does and how, read the <a href="./podman/test-all.sh">comment block at the start of the script itself</a></p>
<h3><a class="anchor" id="autotoc_md2"></a>
Run the test suite</h3>
<div class="fragment"><div class="line">./podman/test-all.sh test11</div>
</div><!-- fragment --><p>Will run the full test suite under a cuda11 container with multiple versions of Python. The detailed output will be placed in <code>/podman/output</code> directory.</p>
<p>If you do not have a GPU, you can still run the tests like this:</p>
<div class="fragment"><div class="line">GATEAU_DISABLE_GPU=1 ./podman/test-all.sh test11</div>
</div><!-- fragment --><p>Mosts tests will fail if there is no GPU.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
Build a wheel</h3>
<div class="fragment"><div class="line">./podman/test-all.sh staticwheel</div>
</div><!-- fragment --><p>This will build wheel and place it into the <code>dist</code> subdirectory.</p>
<p>If you are paranoid, you can run <code>./podman/test-all.sh checkstatic</code> to verify that the wheel has libgsl linked statically (more info in the <a href="#libgsl">Libgsl</a> section).</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Upload to pypi</h3>
<p>This will upload all of the wheels and source archives under <code>dist</code> onto PyPI. You will need to pass your PyPI token using the <code>TWINE_PASSWORD</code> environment variable. You can make a token in the pypi webui.</p>
<div class="fragment"><div class="line">TWINE_USERNAME=__token__ TWINE_PASSWORD=pypi-xxxxxxx --verbose --skip-existing --non-interactive dist<span class="comment">/*</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md5"></a>
Test the PyPI package</h3>
<p>This will download the latest Gateau from PyPI, install it, and run the test suite. As with the <code>test11</code> subcommand, the detailed output will be available under <code>podman/output</code>.</p>
<div class="fragment"><div class="line">./podman/test-all.sh test-pypi</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md6"></a>
Upload/test on TestPyPI</h3>
<p>There exists a "playground" version of PyPI at <a href="https://test.pypi.org/">https://test.pypi.org/</a>. You can use it to play around with the Gateau packing process. Instead of using the <code>pypi</code> and <code>test-pypi</code> subcommands, use the <code>tpypi</code> and <code>test-tpypi</code> subcommands to target TestPyPI instead.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
For developers: building and publishing wheels</h2>
<p>The wheel building and publishing process is automated using the <code>test-all.sh</code> script, please read <a href="#for-developers-using-the-test-allsh-script">the section on using it</a>. Otherwise, you can follow the manual instructions below:</p>
<p>To build wheels for gateau and upload to pypi you will need all of the requirements for compiling Gateau (see the <a href="#manual-compiling">Compiling section</a>), plus the <code>twine</code> and <code>build</code> Python packages.</p>
<ol type="1">
<li>Make sure the package version specified in <code>pyproject.toml</code> is the version number that you want to publish.</li>
</ol>
<ol type="1">
<li>Build wheel: run <code>python -m build</code> from the root of the repo. The results (<code>.whl</code> wheel and <code>.tag.gz</code> source archive) are placed into the <code>dist</code> subdirectory.</li>
</ol>
<ol type="1">
<li>Fix name of wheel: <strike>For some godforsaken reason</strike> <code>build</code> generates wheel files that are named like <code>gateau-0.1.0-cp313-cp313-linux_x86_64.whl</code>, which PyPI WILL NOT ACCEPT. You need to change the part that says <code>linux_x86_64</code> into <code>manylinux_&lt;majver&gt;_&lt;minver&gt;</code>, where <code>&lt;majver&gt;</code> and <code>&lt;minver&gt;</code> are the version numbers of GNU libc. So for example if <code>build</code> generates a file named <code>gateau-0.1.0-cp313-cp313-linux_x86_64.whl</code>, and <code>ldd --version</code> tells you that you have <code>ldd (Ubuntu GLIBC 2.31-0ubuntu9.12) 2.31</code>, then you need to rename the file to <code>gateau-0.1.0-cp313-cp313-manylinux_2_31_x86_64.whl</code>. Read <a href="https://peps.python.org/pep-0427/#file-name-convention">this PEP</a> for more info.</li>
</ol>
<ol type="1">
<li>Upload to pypi: There are many ways to authenticate to pypi, but the easiest is to create an access token in the webui and pass it to <code>twine</code> via the <code>TWINE_PASSWORD</code> environment variable: <code>TWINE_USERNAME=__token__ TWINE_PASSWORD=pypi-xxxxxxx --verbose --skip-existing --non-interactive dist/*</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md8"></a>
Libgsl</h2>
<p>In Python Land, it is customary to statically link dependencies into the wheel. Our only dependency (besides C and C++ stdlibs, which are halal to link dynamically afaik) is the <a href="https://www.gnu.org/software/gsl/">GNU Scientific Library</a>. We link it statically into <code>libgateau.so</code>. In order to accomplish this, a static version of libgsl itself is needed &ndash; i.e. <code>libgsl.a</code> instead of <code>libgsl.so</code>. Some distros provide a package for this, but not Ubuntu (which is the base for the <code>gateau-cicd</code> container). So we compile static libgsl manually. This is done using the <code>scripts/build-gsl.sh</code> script, which runs during the <code>staticwheel</code> subcommand of the <code>test-all.sh</code> script. That script has a little non-trivial hackery to actually get libgsl to compile, go take a look yourself, I promise it's not that scary.</p>
<p>cmake is duumb. I have spent like an hour trying to figure out how to tell it to link libgsl statically and the best I have come up with is to just make sure the container ONLY has the static libgsl (<code>libgsl.a</code>). If the container has both static and dynamic (<code>libgsl.so</code>), cmake defaults to the dynamic one no matter what I do. This is the reason why the <code>build-gsl.sh</code> script configures libgsl with <code>--distable-shared</code>, and why the <code>staticwheel</code> subcommand has that cheeky <code>rm -rf /usr/local/bin/libgsl.so*</code>, and why there is the paranoid <code>checkstatic</code> subcommand as well.</p>
<p>Libgsl is licensed under GPLv3 which is the reason we must use a GPL-compatible license for Gateau itself if we want to distribute static wheels of it.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
CICD</h2>
<p>We have somewhat of a CICD pipeline. See the <a href="https://github.com/stratal-systems/wiki/blob/main/wiki/gateau-cicd.md">stratal systems wiki page</a> for full info.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Publishing pages</h3>
<p>The documentation is published to the <a href="https://tifuun.github.io/gateau/">pages site</a> automatically. To trigger it you should:</p>
<ol type="1">
<li>Tag the commit you want to publish</li>
</ol>
<ol type="1">
<li>Push the tag to github</li>
</ol>
<ol type="1">
<li>Push the commit to either <code>main</code> or <code>cicdtest</code> branches.</li>
</ol>
<blockquote class="doxtable">
<p>[!WARNING] You must FIRST push the TAG and THEN push the COMMIT. Otherwise minicycle will pull the commit before it has the tag and skip building pages. So roughly: </p><div class="fragment"><div class="line">git commit -m <span class="stringliteral">&quot;Updated the docs&quot;</span></div>
<div class="line">git tag <span class="stringliteral">&#39;v4.2.0&#39;</span></div>
<div class="line">git push --tags</div>
<div class="line">git push</div>
</div><!-- fragment --><p></p>
</blockquote>
<h3><a class="anchor" id="autotoc_md11"></a>
Running tests (CI)</h3>
<p>The automatic tests pipeline runs on ANY commit to <code>master</code> or <code>cicdtest</code>. Read the <a href="https://github.com/stratal-systems/wiki/blob/main/wiki/gateau-cicd.md">stratal systems wiki page</a> for full info.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Publishing to pypi (CD)</h3>
<p>There is no automated way to publish to pypi yet.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Internals</h3>
<p>All pipelines start at <code>./.minicycle/entrypoint</code> which then launches <code>./.minicycle/tests</code>, and, if a tag is present, <code>./.minicycle/pages</code>. They both make use of the <code>./podman/test-all.sh</code> script to run tests / build the docs. The docs are ultimately built by <code>./scripts/GenerateDocs.py</code>.</p>
<p>The docs are published to github pages by having the pipeline push the built docs to the <code>gh-pages</code> branch in this repo through a read-write deploy key. Do not push to <code>gh-pages</code> branch manually.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Misc. notes for various linux distros</h2>
<h3><a class="anchor" id="autotoc_md15"></a>
Void Linux</h3>
<ul>
<li>no clue about getting cuda to work, but that is not needed to just compile</li>
<li><code>xbps-install -Syu gcc cmake gsl-devel</code></li>
</ul>
<h3><a class="anchor" id="autotoc_md16"></a>
Oracle Linux 9</h3>
<ul>
<li>Available pythons: 3.9, 3.11, 3.12</li>
<li>Extra repos need to be added for googletest:</li>
</ul>
<div class="fragment"><div class="line">dnf install -y oracle-epel-release-el9</div>
<div class="line">dnf config-manager --set-enabled ol9_developer_EPEL</div>
<div class="line">dnf install -y gtest gtest-devel gsl-devel python3.11</div>
<div class="line"> </div>
<div class="line">python3.11 -m venv /venv</div>
<div class="line">source /venv/bin/activate</div>
<div class="line"> </div>
<div class="line">pip install -e .</div>
<div class="line">python -m unittest</div>
<div class="line">TODO gtest</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md17"></a>
Ubuntu 20.04</h3>
<ul>
<li><code>deadsnakes</code> repo needed for non-ancient Pythons<ul>
<li>contains almost all releases of python that you might ever want (3.9, 3.10, 3.11, 3.12, 3.13)</li>
<li><code>venv</code> shipped separately, so you need to install both <code>pythonX.XX</code> and <code>pythonX.XX-venv</code></li>
</ul>
</li>
<li><code>gsl-devel</code> is called <code>libgsl-dev</code></li>
<li>TODO gtest</li>
</ul>
<div class="fragment"><div class="line">apt install -y libgsl-dev software-properties-common</div>
<div class="line">add-apt-repository ppa:deadsnakes/ppa</div>
<div class="line">apt update -y</div>
<div class="line">apt install python3.11 python3.11-venv</div>
<div class="line"> </div>
<div class="line">python3.11 -m venv /venv</div>
<div class="line">source /venv/bin/activate</div>
<div class="line"> </div>
<div class="line">pip install -e .</div>
<div class="line">python -m unittest</div>
<div class="line">TODO gtest</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
Other misc notes for developers</h2>
<h3><a class="anchor" id="autotoc_md19"></a>
Changing the signature of &lt;tt&gt;run_gateau&lt;/tt&gt;</h3>
<p>If you want to add/remove arguments of <code>run_gateau</code> there's four places you need to change it:</p>
<ul>
<li><code>InterfaceCUDA.h</code></li>
<li><code>SimKernels.cu</code></li>
<li><code>bindings.py</code> &ndash; the Python function itself</li>
<li><code>bindings.py</code> &ndash; the call to the C++ code </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
